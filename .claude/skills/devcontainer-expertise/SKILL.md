---
name: Dev Container Feature Expertise
version: 1.0
depends-on: []
allowed-tools: [Bash, Read, Write, Edit, Grep, Glob]
---

# Dev Container Feature Expertise

Specialized knowledge for implementing Dev Container Features per the [containers.dev specification](https://containers.dev/implementors/features/).

## Purpose & Scope

This skill provides expertise for:
- Creating `devcontainer-feature.json` manifests
- Writing `install.sh` scripts that run as root
- Implementing test scenarios with the devcontainer CLI
- Understanding feature option patterns and conventions

## Core Concepts

### Feature Structure

Every feature lives in `src/<feature-name>/` with:

```
src/<feature-name>/
├── devcontainer-feature.json   # Required: metadata and options
├── install.sh                  # Required: installation script
└── README.md                   # Auto-generated, do not edit
```

### devcontainer-feature.json Schema

```json
{
    "name": "Human readable name",
    "id": "feature-id",
    "version": "1.0.0",
    "description": "What this feature does",
    "options": {
        "optionName": {
            "type": "boolean|string",
            "default": "value",
            "description": "What this option does"
        }
    },
    "dependsOn": {
        "ghcr.io/some/feature": {}
    }
}
```

**Key rules:**
- `id` must match directory name
- `version` follows semver
- Options use camelCase
- Boolean options: `"type": "boolean", "default": true`
- String options: `"type": "string", "default": "value"`

### install.sh Conventions

```bash
#!/bin/sh
set -e

# Options are passed as environment variables (UPPERCASE)
# Option "installTool" becomes $INSTALLTOOL
# Option "toolVersion" becomes $TOOLVERSION

# Available context variables:
# $_REMOTE_USER - The dev container's remote user
# $_REMOTE_USER_HOME - Remote user's home directory
# $_CONTAINER_USER - Container user
# $_CONTAINER_USER_HOME - Container user's home directory

# Script runs as root
# Install to /usr/local/bin by convention
```

**Best practices:**
- Use `#!/bin/sh` for POSIX compatibility (not bash)
- Always `set -e` for fail-fast
- Check option values: `if [ "$INSTALLTOOL" = "true" ]; then`
- Log meaningful messages for debugging
- Clean up temp files

### Test Structure

Tests live in `test/<feature-name>/`:

```
test/<feature-name>/
├── scenarios.json          # Defines test scenarios
├── test.sh                 # Auto-generated
├── <scenario-name>.sh      # Per-scenario test scripts
```

### scenarios.json Format

```json
{
    "scenarios": {
        "default": {
            "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
            "features": {
                "devenv": {}
            }
        },
        "custom-options": {
            "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
            "features": {
                "devenv": {
                    "optionName": "value"
                }
            }
        }
    }
}
```

### Test Script Pattern

```bash
#!/bin/bash
set -e

# Test binary existence
check() {
    local cmd="$1"
    if command -v "$cmd" &>/dev/null; then
        echo "✓ $cmd found"
    else
        echo "✗ $cmd NOT found"
        exit 1
    fi
}

check "tool-name"
echo "All tests passed!"
```

## Procedures & Workflows

### Creating a New Feature

1. Create directory: `mkdir -p src/<feature-name>`
2. Create `devcontainer-feature.json` with metadata and options
3. Create `install.sh` with installation logic
4. Create `test/<feature-name>/scenarios.json`
5. Create test scripts for each scenario
6. Run tests: `devcontainer features test -f <feature-name> .`

### Testing Commands

```bash
# Run all tests for a feature
devcontainer features test -f <feature> .

# Run only scenario tests (skip auto-generated)
devcontainer features test -f <feature> --skip-autogenerated .

# Test against specific image
devcontainer features test -f <feature> -i mcr.microsoft.com/devcontainers/base:ubuntu .

# Skip scenarios, run only auto-generated
devcontainer features test -f <feature> --skip-scenarios .
```

### Downloading from GitHub Releases

```bash
# Get latest version
get_latest_version() {
    local repo="$1"
    curl -s "https://api.github.com/repos/$repo/releases/latest" | \
        grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/'
}

# Download release asset
download_release() {
    local repo="$1"
    local version="$2"
    local asset="$3"
    local url="https://github.com/$repo/releases/download/$version/$asset"
    curl -fsSL "$url" -o "/tmp/$asset"
}
```

### Architecture Detection

```bash
detect_arch() {
    local arch
    arch=$(uname -m)
    case "$arch" in
        x86_64)  echo "amd64" ;;
        aarch64) echo "arm64" ;;
        armv7l)  echo "arm" ;;
        *)       echo "$arch" ;;
    esac
}
```

## Standards & Requirements

### Naming Conventions

- Feature ID: lowercase with hyphens (`my-feature`)
- Options: camelCase (`installTool`, `toolVersion`)
- Environment variables in install.sh: UPPERCASE (`$INSTALLTOOL`)

### Error Handling for Graceful Failure

```bash
install_tool() {
    local name="$1"
    local url="$2"

    echo "Installing $name..."
    if ! curl -fsSL "$url" -o "/tmp/$name"; then
        echo "WARNING: Failed to download $name, skipping" >&2
        return 0  # Don't fail the build
    fi

    # Continue with installation...
}
```

### Setting Environment Variables

Create files in `/etc/profile.d/` for login shells:

```bash
# Set EDITOR when nvim is installed
if [ "$INSTALLNVIM" = "true" ]; then
    echo 'export EDITOR=nvim' >> /etc/profile.d/devenv.sh
    echo 'export VISUAL=nvim' >> /etc/profile.d/devenv.sh
fi
```

## Quick Reference

| Task | Command |
|------|---------|
| Test feature | `devcontainer features test -f <name> .` |
| Test specific scenario | Use scenarios.json + scenario script |
| Validate JSON | Auto-validated by CI |
| Check shell script | `shellcheck src/<name>/install.sh` |

### Common Base Images

| Image | Distro | Package Manager |
|-------|--------|-----------------|
| `mcr.microsoft.com/devcontainers/base:ubuntu` | Ubuntu | apt |
| `mcr.microsoft.com/devcontainers/base:debian` | Debian | apt |
| `mcr.microsoft.com/devcontainers/base:alpine` | Alpine | apk |
| `mcr.microsoft.com/devcontainers/base:fedora` | Fedora | dnf |

### Option Type Examples

```json
{
    "installTool": {
        "type": "boolean",
        "default": true,
        "description": "Install the tool"
    },
    "toolVersion": {
        "type": "string",
        "default": "latest",
        "description": "Version to install"
    }
}
```
