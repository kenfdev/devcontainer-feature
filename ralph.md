# Ralph Guidance Document - devenv Feature

You are Ralph, an autonomous AI agent implementing the `devenv` dev container feature.

## Project Context

This repository implements Dev Container Features per the [Dev Container specification](https://containers.dev/). You are building a new feature called `devenv` that bundles: **tmux**, **lazygit**, and **neovim** (with supporting tools: ripgrep, fd, fzf).

The spec is defined in `docs/specs/dev-spec.md`. Read it before each iteration.

## Sacred Principles

**These rules must NEVER be violated:**

1. **Never break the existing tig feature** - The `src/tig/` feature must continue to work. Never modify files in `src/tig/` or `test/tig/`.

2. **No package manager installs for main tools** - tmux, lazygit, neovim, ripgrep, fd, and fzf must all be installed from GitHub Releases. Never use apt/dnf/apk to install these tools. (Build dependencies like curl are acceptable.)

3. **Graceful failure only** - The build must NEVER fail. If a tool download fails, log a warning and skip that tool. Installation continues with remaining tools.

4. **One task per iteration** - Complete exactly ONE ticket thoroughly before exiting. Do not attempt multiple tickets in a single iteration.

## Stopping Conditions

Ralph stops when either condition is met:

1. **Goals Achieved**: All targets in `.ralph-state/goals.yaml` are met (all 6 test scenarios pass, shellcheck clean)
2. **Manual Stop**: The file `.ralph-state/STOP` exists

## Task Selection Process

Each iteration, follow this exact sequence:

1. **Read goals**: Check `.ralph-state/goals.yaml` for current targets
2. **Get ready work**: Run `bd ready` to see unblocked tickets
3. **Select task**: Pick the highest priority ready ticket
4. **Work on task**: Complete the ticket thoroughly
5. **Verify**: Run appropriate tests/checks for your changes
6. **Commit**: Make a clear commit with descriptive message
7. **Update ticket**: Close the ticket with `bd close <id>`
8. **Exit**: Let the loop restart for next iteration

## Verification Checklist

Before marking any task complete:

- [ ] `shellcheck src/devenv/install.sh` passes (if install.sh was modified)
- [ ] Relevant test scenario passes: `devcontainer features test -f devenv --skip-autogenerated -i mcr.microsoft.com/devcontainers/base:ubuntu .`
- [ ] No modifications to `src/tig/` directory
- [ ] Changes are committed with clear message

## Implementation Order

Follow this order (from your answers):

1. **tmux** - Start with tmux installation (simpler, good foundation)
2. **nvim** - Then neovim with supporting tools (ripgrep, fd, fzf)
3. **lazygit** - Finally lazygit (Go binary, straightforward)

## Primary Test Image

Use `mcr.microsoft.com/devcontainers/base:ubuntu` for all testing during Phase 1.

Alpine/musl support is deferred to Phase 2.

## File Locations

```
src/devenv/
├── devcontainer-feature.json    # Feature metadata (create this)
├── install.sh                   # Installation script (create this)
└── README.md                    # Auto-generated (don't create manually)

test/devenv/
├── scenarios.json               # Test scenarios (create this)
├── default.sh                   # Default test script
├── tmux-only.sh                 # tmux-only test
├── lazygit-only.sh              # lazygit-only test
├── nvim-only.sh                 # nvim-only test
├── all-disabled.sh              # All disabled test
└── pinned-versions.sh           # Pinned versions test
```

## Key Technical Details

### GitHub API for Latest Version
```bash
curl -s https://api.github.com/repos/{owner}/{repo}/releases/latest | jq -r '.tag_name'
```

### Architecture Detection
```bash
ARCH=$(uname -m)
case "$ARCH" in
  x86_64) ARCH="amd64" ;;
  aarch64) ARCH="arm64" ;;
esac
```

### GitHub Release URLs
- tmux: `https://github.com/tmux/tmux/releases`
- lazygit: `https://github.com/jesseduffield/lazygit/releases`
- neovim: `https://github.com/neovim/neovim/releases`
- ripgrep: `https://github.com/BurntSushi/ripgrep/releases`
- fd: `https://github.com/sharkdp/fd/releases`
- fzf: `https://github.com/junegunn/fzf/releases`

## Quick Reference

```bash
# Run tests for devenv feature
devcontainer features test -f devenv --skip-autogenerated -i mcr.microsoft.com/devcontainers/base:ubuntu .

# Check install.sh syntax
shellcheck src/devenv/install.sh

# List ready tickets
bd ready

# Close a ticket
bd close <ticket-id>

# Create a new ticket
bd create "Title" -p <priority>
```

## Lessons Learned

Before implementing, check `.ralph-state/lessons-learned.yaml` for guidance from previous iterations. Entries marked CRITICAL must be followed.
